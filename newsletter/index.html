<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Newsletter Dashboard</title>
</head>
<body>
  <h1>Newsletter Dashboard</h1>

  <button id="loginBtn">Login with Cognito</button>
  <button id="refreshBtn" style="display:none;">Refresh</button>

  <h2>Subscribe</h2>
  <form id="subscribeForm" style="margin-bottom:1em;">
    <input type="text" id="firstName" placeholder="First Name" required />
    <input type="email" id="emailAddress" placeholder="Email Address" required />
    <button type="submit" id="subscribeBtn" disabled>Subscribe</button>
  </form>

  <div id="subscribeResult"></div>
  <div id="output"></div>

  <script>
    const clientId = "7ftcq3nq571hpgt92jb1ihm0ch";
    const domain = "https://cognito-idp.us-east-1.amazonaws.com/us-east-1_Na0TJILzS";
    const redirectUri = "https://dev.isaacd2.com/newsletter";
    const apiUrl = "https://beacon.isaacd2.com";

    // Step 1: Redirect to Cognito login
    document.getElementById("loginBtn").onclick = () => {
      const loginUrl = 'https://us-east-1na0tjilzs.auth.us-east-1.amazoncognito.com/login/continue?client_id=7ftcq3nq571hpgt92jb1ihm0ch&redirect_uri=https%3A%2F%2Fdev.isaacd2.com%2Fnewsletter&response_type=token&scope=email+openid+phone';
      window.location = loginUrl;
    };

    // Step 2: Parse token from URL hash after redirect
    function parseHash() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      return {
        id_token: params.get("id_token"),
        access_token: params.get("access_token"),
        expires_in: params.get("expires_in"),
        token_type: params.get("token_type")
      };
    }
    // Parse tokens from URL hash
    const tokens = parseHash();

    // If just logged in, store token and update UI
    if (tokens.id_token) {
      localStorage.setItem("id_token", tokens.id_token);
      document.getElementById("output").textContent = "Logged in!";
    }

    // Enable subscribe/refresh if token is present in localStorage
    if (localStorage.getItem("id_token")) {
      document.getElementById("subscribeBtn").disabled = false;
      document.getElementById("refreshBtn").style.display = "inline-block";
      callApi(); // Call API on page load
    }

    // Render subscribers as a table
    function renderSubscribers(data) {
      if (!Array.isArray(data)) {
        document.getElementById("output").textContent = "No data.";
        return;
      }
      if (data.length === 0) {
        document.getElementById("output").textContent = "No subscribers found.";
        return;
      }
      let html = `<table style="border-collapse:collapse;width:100%;max-width:600px;">
        <thead>
          <tr style="background:#f0f0f0;">
            <th style='border:1px solid #ccc;padding:6px 10px;text-align:left;'>First Name</th>
            <th style='border:1px solid #ccc;padding:6px 10px;text-align:left;'>Email</th>
            <th style='border:1px solid #ccc;padding:6px 10px;text-align:left;'>Subscription Date</th>
          </tr>
        </thead>
        <tbody>`;
      for (const sub of data) {
        html += `<tr>
          <td style='border:1px solid #ccc;padding:6px 10px;'>${sub.firstName || ""}</td>
          <td style='border:1px solid #ccc;padding:6px 10px;'>${sub.emailAddress || ""}</td>
          <td style='border:1px solid #ccc;padding:6px 10px;'>${sub.subscriptionDate || ""}</td>
        </tr>`;
      }
      html += `</tbody></table>`;
      document.getElementById("output").innerHTML = html;
    }

    // Function to call the /subscribers API
    async function callApi() {
      const token = localStorage.getItem("id_token");
      if (!token) return;
      try {
        const res = await fetch(apiUrl + "/subscribers", {
          method: "GET",
          headers: {
            Authorization: token
          }
        });
        const data = await res.json();
        renderSubscribers(data);
      } catch (err) {
        document.getElementById("output").textContent = "Error: " + err;
      }
    }

    // Refresh button handler
    document.getElementById("refreshBtn").onclick = callApi;

  // ...removed callApiBtn handler...

    // Step 4: Subscribe form handler
    document.getElementById("subscribeForm").onsubmit = async (e) => {
      e.preventDefault();
      const token = localStorage.getItem("id_token");
      const name = document.getElementById("firstName").value;
      const email = document.getElementById("emailAddress").value;
      try {
        const res = await fetch(apiUrl + "/subscribe", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: token
          },
          body: JSON.stringify({
            emailAddress: email,
            firstName: name
          })
        });
        // Try to parse JSON, but if not, show text
        let msg = '';
        try {
          const data = await res.json();
          msg = data && typeof data === 'object' ? JSON.stringify(data, null, 2) : String(data);
        } catch (e) {
          msg = await res.text();
        }
        document.getElementById("subscribeResult").textContent = msg;
        // Optionally, refresh the table after subscribing
        callApi();
      } catch (err) {
        document.getElementById("subscribeResult").textContent = "Error: " + err;
      }
    };
  </script>
</body>
</html>
