<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Newsletter Dashboard</title>
</head>
<body>
  <h1>Newsletter Dashboard</h1>
  <button id="loginBtn">Login with Cognito</button>
  <button id="callApiBtn" disabled>Call API</button>

  <pre id="output"></pre>

  <script>
    const clientId = "7ftcq3nq571hpgt92jb1ihm0ch";
    const domain = "https://cognito-idp.us-east-1.amazonaws.com/us-east-1_Na0TJILzS";
    const redirectUri = "https://dev.isaacd2.com/newsletter";
    const apiUrl = "https://4yyvatwani.execute-api.us-east-1.amazonaws.com/development";

    // Step 1: Redirect to Cognito login
    document.getElementById("loginBtn").onclick = () => {
      const loginUrl = 'https://us-east-1na0tjilzs.auth.us-east-1.amazoncognito.com/login/continue?client_id=7ftcq3nq571hpgt92jb1ihm0ch&redirect_uri=https%3A%2F%2Fdev.isaacd2.com%2Fnewsletter&response_type=token&scope=email+openid+phone';
      window.location = loginUrl;
    };

    // Step 2: Parse token from URL hash after redirect
    function parseHash() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      return {
        id_token: params.get("id_token"),
        access_token: params.get("access_token"),
        expires_in: params.get("expires_in"),
        token_type: params.get("token_type")
      };
    }

    const tokens = parseHash();
    if (tokens.id_token) {
      localStorage.setItem("id_token", tokens.id_token);
      document.getElementById("output").textContent = "Logged in!";
      document.getElementById("callApiBtn").disabled = false;
    }

    // Step 3: Use token in API requests
    document.getElementById("callApiBtn").onclick = async () => {
      const token = localStorage.getItem("id_token");
      try {
        const res = await fetch(apiUrl + "/test", {
          method: "GET",
          headers: {
            Authorization: token
          }
        });
        const data = await res.json();
        document.getElementById("output").textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        document.getElementById("output").textContent = "Error: " + err;
      }
    };
  </script>
</body>
</html>
